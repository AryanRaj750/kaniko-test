pipeline {
    agent {
        docker { }
    }
    environment {
        JAVA_WEB_API = 'http://52.41.117.187:31127/sentiment'
        APP_NAME = "sa-frontend"
        REGION = "us-west-2"
        ECR_URI = "166287152401.dkr.ecr.us-west-2.amazonaws.com"
        REPO_NAME   = 'sa-frontend'
    }
    stages {
        stage('React-Frontend-Image-Build') {            
            options {
                timeout(time: 1, unit: 'HOURS') 
                retry(1) 
            }
            steps {
                echo 'Building Front-End React App'
                sh   "sed  -i 's,http://localhost:8080/sentiment,$JAVA_WEB_API,g' sa-frontend/src/App.js"
                sh   'docker build -f ./sa-frontend/Dockerfile -t ${APP_NAME}:$BUILD_ID ./sa-frontend'
                sh   'sudo docker tag ${APP_NAME}:$BUILD_ID ${ECR_URI}/${REPO_NAME}:$BUILD_ID'
                
            }
        }   
        stage('React-Frontend-Image-Push') {            
            options {
                timeout(time: 1, unit: 'HOURS') 
                retry(1) 
            }
            steps {
                script {
                    sh   'aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin ${ECR_URI}'
                    sh   'docker push ${ECR_URI}/${REPO_NAME}:$BUILD_ID'
                    echo 'Image has Pushed!'
                }
                
            }
        }        
    }
}
